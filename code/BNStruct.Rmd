---
title: "BNStruct"
author: "Stewart Kerr"
date: "April 20, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(bnstruct)
library(dplyr)
library(reshape)
library(tidyr)
#library(graph)
#library(Rgraphviz) required to plot DBN
df <- read.delim("../data/DREAM4_InSilico_Size10/insilico_size10_2/insilico_size10_2_timeseries.tsv", comment.char="#")

#Get number of timepoints
timepoints <- df[1] %>% unique()

#Temporarily reduce # of timepoints
n_timepoints <- 2

#Get gene names/numbers
gene_names <- colnames(df)[-1]
n_genes <- length(gene_names)

#Tranpose the data for BNDataset
df_unstack <- function(df,start){
  #Height of the stacks
  timepoints <- df[1] %>% unique()
  n_timepoints <- nrow(timepoints)
  
  #Pulls the first n_timepoints rows
  unstack_df <- df[start:(start+n_timepoints-1),]
  
  return(unstack_df)
}

df_widen <- function(unstack_df){
  #Transposes the dataset to get it in the right form for BN
  wide_unstack_df <- data.frame()
  for (tp in 1:n_timepoints){
    wide_unstack_df = c(wide_unstack_df, unstack_df[tp,-1])
  }
  
  return(as.data.frame(wide_unstack_df))
}

wide_unstack_df_combine <- function(df){
  timepoints <- df[1] %>% unique()
  n_timepoints = nrow(timepoints)
  n_obs = nrow(df)/n_timepoints
  
  final_df = data.frame()
  for (i in 1:n_obs){
    start = ((i-1)*n_timepoints)+1
    unstack_df = df_unstack(df,start)
    wide_unstack_df = df_widen(unstack_df)
    final_df = rbind(final_df, wide_unstack_df)
  }
  
  return(final_df)
}

bn_ready_df = wide_unstack_df_combine(df)
```


```{r Dynamic Bayes Net}
#Temporary
var_names <- c('G1T1','G2T1','G3T1','G4T1','G5T1','G6T1','G7T1','G8T1','G9T1','G10T1','G1T2','G2T2','G3T2','G4T2','G5T2','G6T2','G7T2','G8T2','G9T2','G10T2')


#Creates a BN dataset
bn_df <- BNDataset(data = bn_ready_df,
                   variables = var_names,#rep(gene_names,n_timepoints),
                   discreteness = rep(rep('c',n_genes),n_timepoints),
                   num.time.steps = n_timepoints,
                   node.sizes = rep(rep(5,n_genes),n_timepoints))

#Examine the dataset
#show(bn_df)

#Attempt to learn network
dbn <- learn.dynamic.network(bn_df, num.time.steps = n_timepoints)
#show(dbn)
#cpts(dbn)
```

```{r Static Bayes Net}
static_df <- select(df, -Time)

#Create BN dataset
bn_df <- BNDataset(data = static_df,
                   variables = gene_names,
                   discreteness = rep('c',n_genes),
                   node.sizes = rep(2,n_genes))

#Learn static network
bn <- learn.network(bn_df, algo = "mmpc", scoring.func = "BDeu")
plot(bn)
```


```{r Linear Regression}
library("corrplot")
library("glmnet")
library("glasso")

#Read in dataset
df <- read.delim("../data/DREAM4_InSilico_Size10/insilico_size10_2/insilico_size10_2_timeseries.tsv", comment.char="#")
dft1 <- df_unstack(df, start = 22)

#Build covariance matrix
df_cov <- cov(dft1[-1])

#Building network - simple linear regression
grn <- lm(G1 ~ G10+G2+G3+G4+G5+G6+G7+G8+G9, data = df)


#Correlation matrix
#rquery.cormat(df)

#LASSO
#glmnet(df[,3:11], df[,2], family = "gaussian", alpha = 1, lambda = NULL)

#GLASSO
glasso(df_cov, rho = 0.009)
```